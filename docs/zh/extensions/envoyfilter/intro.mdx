---
weight: 10
sourceSHA: 3a0b9955e435a81f86ca14714066c807b29ccdc10f84b0d311e394a588b9cc92
---

# 介绍

## EnvoyFilter 介绍

EnvoyFilter API 是 Istio 服务网格中一个强大的自定义机制，使用户能够对由 istiod 生成的 Envoy 代理配置进行细粒度控制。该功能专为高级用户设计，允许修改特定的 Envoy 配置字段、插入自定义过滤器，甚至添加全新的监听器或集群。虽然它提供了无与伦比的灵活性，但 EnvoyFilter 的使用需要谨慎，因为不当的配置可能对网格的稳定性产生影响。

EnvoyFilter 资源会在工作负载之间按累加方式应用。多个过滤器可以共存于同一命名空间，应用顺序遵循以下层次结构：首先是 [根配置命名空间](https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig) 中的所有 EnvoyFilter，其次是工作负载特定命名空间中的 EnvoyFilter。

## 优势

EnvoyFilter 的核心优势包括：

- **高级配置灵活性**\
  允许直接操作超出 Istio 标准网络 API 的 Envoy 代理设置。这使得实现协议特定的优化、自定义重试逻辑或尚未得到本土支持的实验特性成为可能。

- **精细化工作负载控制**\
  支持使用工作负载选择器进行有针对性的自定义，让操作员可以将特定配置应用到特定服务或网关，而不影响整个网格。

- **Istio 集成**\
  与 Istio 控制平面无缝集成，同时保持与现有 Istio 资源（如 VirtualServices 和 DestinationRules）的兼容性。

- **协议扩展性**\
  方便插入自定义的 Envoy 过滤器（L4/L7），以处理专有协议或在代理层实施专门的流量处理逻辑。

## 应用场景

EnvoyFilter 主要用于以下场景：

- **协议扩展**\
  实现自定义协议解析器或 HTTP 过滤器，以满足 Istio 默认支持范围外的专业通信需求。

- **流量 manipulation**\
  插入自定义的 WASM 过滤器，以修改请求/响应头，实施复杂的路由逻辑，或在代理层执行协议转换。

- **安全增强**\
  添加自定义授权过滤器或实施请求验证逻辑，以便与 Envoy 数据平面进行更深层的集成。

- **可观测性扩展**\
  配置自定义访问日志格式、注入跟踪头，或实施指标收集过滤器，以满足专业监控需求。

- **性能调优**\
  为需要优化性能特征的特定服务重写默认的 Envoy 配置参数（例如，连接池设置、超时）。

## 使用注意事项

在使用 EnvoyFilter 时，请注意以下关键事项：

- **版本兼容性**\
  EnvoyFilter 配置与特定的 Envoy 代理版本紧密耦合。对 Istio 控制平面或代理版本的任何更改可能需要更新配置。始终在版本升级中测试配置。

- **配置冲突**\
  应用于同一工作负载的多个 EnvoyFilter 按创建时间戳顺序处理。冲突的配置可能会导致未定义的行为 - 确保过滤器经过仔细排序和验证。

- **实现耦合**\
  某些配置可能依赖于 Istio 的内部实现细节。当可能时，考虑使用标准的 Istio API 采取替代办法，以确保长期兼容性。

- **全局应用**\
  要在整个网格中应用配置，请在根命名空间中创建无工作负载选择器的 EnvoyFilter。谨慎使用该功能，以避免不必要的副作用。

:::danger 操作警告
EnvoyFilter 在抽象级别上低于标准的 Istio 资源。在可能的情况下，总是优先使用本地 Istio API（VirtualService、DestinationRule），并将 EnvoyFilter 保留给无法通过更高层次抽象实现的需要代理级别自定义的用例。
:::
