---
weight: 10
sourceSHA: ba0320f6e78b74b99d26d6c85e6c5b9dd0f483570b7f3ccf2d40afa6d720ef10
---

## 服务网格

服务网格是一种独立且可配置的基础设施层，添加到应用程序中。它用于管理和控制微服务应用之间的通信，提供服务流量管理、服务监控、服务访问安全控制和服务发布的能力。

在传统的微服务架构中，服务之间的通信通常由应用程序代码直接处理，这增加了复杂性和耦合度。服务网格通过在每个服务 Pod 中部署轻量级代理（Envoy，作为边车容器）来管理和控制服务之间的通信。这些代理与应用程序代码分离，处理请求路由、负载均衡、故障恢复、流量控制和安全认证等任务，使开发者能够专注于业务逻辑，而无需担心底层的通信机制和功能。

通过引入服务网格，开发者可以更好地管理和控制微服务应用之间的通信，同时可以在不修改应用程序代码的情况下添加新功能。服务网格支持多种基础设施，如虚拟机和容器，并可以与容器编排平台（如 Kubernetes）集成，从而在云原生时代提供更好的容器化微服务架构体验。

## Istio

[Istio](https://istio.io/latest/about/service-mesh/) 是一个开源服务网格，能够无缝集成到现有的分布式应用中，以提供流量管理、策略执行、遥测收集和安全保障。Istio 为微服务架构提供全面的服务治理能力，支持多种编程语言，并主要使用 Kubernetes 作为服务注册中心。

Istio 提供强大的功能，以统一和高效的方式保护、连接和监控服务。借助 Istio，您可以在最小或无服务代码更改的情况下实现负载均衡、服务间认证和监控。它提供以下关键特性：

- 支持集群内的安全服务间通信，包括 TLS 加密、基于身份的认证和授权。
- 对 HTTP、gRPC、WebSocket 和 TCP 流量进行自动负载均衡。
- 提供丰富的路由规则、重试、故障切换和故障注入的细粒度流量行为控制。
- 可插拔的策略层和配置 API，支持访问控制、速率限制和配额管理。
- 自动收集集群内所有流量的指标、日志和追踪，包括进出流量。
- 可扩展性以满足各种部署需求。控制平面运行在 Kubernetes 上，您可以将部署在集群中的应用程序添加到网格中，将网格扩展到其他集群，甚至可以连接到虚拟机或 Kubernetes 外的其他终端。

Istio 的架构如下所示。

<img src="/zh/img/33servicemesh.svg" width="600" />

**控制平面**

Istio 控制平面负责管理和配置代理。它与数据平面代理（Envoy）进行通信，以发送配置和指令，以控制服务流量、管理安全性以及收集和处理遥测数据。它允许管理员和开发者以集中化的方式管理整个服务网格，并实现灵活配置。

**数据平面**

Istio 数据平面由一组智能代理（Envoy）组成，作为边车容器在服务 Pods 中部署和运行。这些代理负责拦截、处理和转发服务之间的所有流量。

数据平面执行流量管理、故障恢复、安全策略执行等功能，以确保服务间通信的可靠性和安全性。它还提供丰富的监控和追踪能力，帮助开发者理解和调试服务通信行为。

**Envoy**

[Envoy](https://istio.io/latest/docs/ops/deployment/architecture/#envoy) 作为 Istio 数据平面的代理，是唯一与数据平面流量交互的 Istio 组件。

Envoy 被部署并作为边车运行在服务 Pods 中，处理和转发服务网格中所有的入站和出站流量，提供网络功能和管理特性，如流量控制、负载均衡、故障恢复和安全。

**边车**

边车模式广泛应用于微服务和容器化应用中，通过在主应用容器旁添加辅助容器或代理，增强应用的功能和性能。

构成 Istio 数据平面的 Envoy，被作为边车容器部署在服务 Pods 中。

**服务网关**

服务网关包括出口网关和入口网关，运行在服务网格的边缘，管理进入和离开网格的流量。它们允许您指定允许离开或进入网格的流量。

## OpenTelemetry

OpenTelemetry 是一个开源可观测性框架，旨在生成、处理和传输遥测数据，包括指标、日志和追踪。由云原生计算基金会（CNCF）开发，它提供了一组标准协议和工具，用于将数据发送到任何可观测性后端。OpenTelemetry 的核心组件包括：

- 收集器：接收、处理和导出遥测数据。
- 语言 SDK：允许通过特定语言的 OpenTelemetry API 生成遥测数据。
- 插件库：自动或手动为应用程序进行工具组合，以收集遥测数据。

OpenTelemetry 支持多种语言和第三方注册中心，为 JVM 和中间件提供可观测性数据。它定义了行业标准的数据规范，促进与各种开源可观测性工具的更好集成。

## Istio 和 OpenTelemetry 之间的技术比较

| 特性/能力                    | Istio                                                                                                                                                                                                                                                                | OpenTelemetry                                                                                                                                                                                                                                                    |
|------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **协议支持**                 | 支持 gRPC、HTTP、TCP 协议。                                                                                                                                                                                                                                       | 支持 HTTP、TCP 及各种 RPC 协议，如 Dubbo、Redis 等。                                                                                                                                                                                                         |
| **服务治理**                 | 提供负载均衡、断路器、连接池、超时重试等功能。                                                                                                                                                                                                                       | 无治理能力。                                                                                                                                                                                                                                                     |
| **服务路由**                 | 提供丰富的路由规则和策略，如权重路由、请求头路由、流量镜像、故障注入等。                                                                                                                                                                                           | 无路由能力。                                                                                                                                                                                                                                                    |
| **拓扑结构和调用链**         | 显示网格内的所有节点，包括服务、入口网关、服务条目、出口网关，但不包括中间件节点。<br />调用链包括为注入边车的服务提供的 HTTP 调用跨度，包含 URL、状态代码等数据。                                                                                     | 显示包括服务和中间件的节点，但不包括入口和出口网关。<br />调用链包括 HTTP 链接数据、内部方法调用链数据和服务到中间件的链接数据。跨度数据也可以通过 SDK 主动报告。                                                                                                        |
| **监控数据**                 | 提供服务的完整进出流量指标。                                                                                                                                                                                                                                        | 提供服务的完整进出流量指标以及 JVM 指标。                                                                                                                                                                                                                       |
| **注册中心兼容性**           | 支持 Kubernetes 作为服务注册中心。                                                                                                                                                                                                                                | 支持第三方注册中心和 Kubernetes 注册中心。                                                                                                                                                                                                                     |
| **追踪 ID 传播**             | 需要代码更改以实现追踪 ID 的传播。                                                                                                                                                                                                                                | 实现自动的追踪 ID 传播。                                                                                                                                                                                                                                       |
| **资源需求**                 | 可能需要更多计算资源，因为每个服务实例需要一个 Envoy 代理。                                                                                                                                                                                                      | 所需额外资源较少，无需在每个服务实例旁边配置代理。                                                                                                                                                                                                             |

### 选择建议

- **服务治理**：如果需要服务治理，Istio 是更好的选择。
- **可观测性**：如果需要强大的可观测性支持，特别是针对 JVM 监控，OpenTelemetry 更加适用。
- **资源受限环境**：在资源有限的环境中，OpenTelemetry 可能是更轻量的选择，因为不需要在每个服务实例旁边配置代理。
- **多语言和注册支持**：对于需要多语言支持和使用第三方注册的场景，OpenTelemetry 提供了更多灵活性。
- **非侵入式追踪 ID 传播**：如果您正在使用 Java 应用程序，并希望实现非侵入式追踪 ID 传播以进行全栈追踪，使用 OpenTelemetry 的 Java Agent 是一个极好的选择。

每种技术都有其独特的优势和适用场景。选择应基于特定的业务需求、技术栈以及未来的可扩展性和集成考虑。在某些情况下，两者可以结合使用，以实现全面的服务治理和可观测性解决方案。
