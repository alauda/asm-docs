---
weight: 10
sourceSHA: 00563b96faf91f4629e44c1af8edfef50332fd1036236c473b648846a8199d26
---

# 服务路由

## 介绍

服务路由使用基于 Istio 的规则实现对服务间流量的精确控制。此功能包括：

- 管理服务之间的请求分配
- 支持复杂的流量拆分场景
- 实施故障恢复机制
- 提供无侵入的测试能力

核心价值：为微服务架构提供精细的流量管理

## 特性

- 基于 6 个请求属性的条件路由
- 基于权重的流量分配
- 5 种高级流量策略
- 跨集群路由支持

## 优势

**精准**：1% 粒度的流量控制  
**灵活**：基于头信息/URI/源的匹配  
**安全**：内置断路器机制  
**可观察性**：与监控指标集成  

## 路由规则配置

### 规则类型

```yaml
http:
• match:
  • headers:
      user-type: internal
  route:
    ◦ destination:
        host: staging-service
      weight: 100
```

| 类型      | 优先级 | 匹配字段               |
| --------- | ------ | --------------------- |
| 条件     | 高    | URI/头信息/源标签     |
| 权重     | 低    | 百分比分配           |

### 参数规范

| 参数       | 约束        | 示例              |
|-----------|-----------|-----------------|
| 权重      | 总和=100%  | v1:80%, v2:20%  |
| 正则匹配  | RE2 语法   | `^/api/v\d+/`   |

## 路由策略管理

### 策略类型

```yaml
retries:
  attempts: 3
  perTryTimeout: 2s
  retryOn: 5xx
```

| 策略          | 参数                   | 兼容性        |
|---------------|------------------------|--------------|
| 故障注入      | 错误率(10%), 代码(400) | ❌ 镜像        |
| 流量镜像      | 目标服务, 端口         | ✔️ 重写       |
| 请求重写      | 主机/URI               | 仅权重规则    |

### 超时计算

```
全局超时 (100ms) ≥
(重试超时 (10ms) × (重试次数 (8) + 1))
→ 有效配置
```

## 路由创建流程

### 前提条件

- 服务协议端口已配置
- 灰度发布已禁用
- 跨集群发现已启用（可选）

### 步骤实施

1. 导航：**服务列表** > **目标服务**
2. 选择 **路由** > **HTTP** 标签
3. 点击每个集群的 **创建路由**

```yaml
# 示例路由配置
• match:
  • uri:
      prefix: "/checkout"
  route:
    ◦ destination:
        host: payment-service
      weight: 100
    fault:
      delay:
        percentage: 5
        fixedDelay: 100ms
```

## 操作约束

1. **协议限制**：
   - TCP 路由不包括高级策略
   - gRPC 需要 HTTP/2 端点

2. **优先级系统**：
   - 条件规则自上而下执行
   - 权重规则处理未匹配的流量

3. **版本兼容性**：
   - 需要 Istio 1.6+ 以支持正则匹配
   - 需要 Kubernetes 1.18+ 以支持基于标签的路由
