---
weight: 30
i18n:
  title:
    en: Upgrade
    zh: 升级
sourceSHA: 8430a28bb9319b7e91113118760dfd8ea5654267f0685e1223fb32db9a2dd9a1
title: 升级
---

## 安装最新的 Global Alauda 服务网格基础集群插件

请访问 [Alauda AI Essentials](./install/asm-essentials.mdx) 获取安装说明。

## 升级业务集群组件

### <span id="ref">升级前准备</span>

该平台为服务网格中的 Istio 提供了金丝雀升级，首先部署新版本的 istiod 组件。所有数据平面升级完成后，旧版本的 istiod 组件将被退役。

由于 Istio 版本与 Kubernetes 版本之间存在较强的依赖关系，因此在升级 Istio 之前，请确保集群的当前 Kubernetes 版本满足 Istio 的升级要求，以顺利完成金丝雀升级。

下表显示了当前平台版本所支持的 Istio 升级路径及其所需的 Kubernetes 版本。

| 支持的 Istio 升级路径          | Kubernetes 版本要求               |
| ------------------------------ | --------------------------------- |
| Istio 从 1.20 升级到 1.22      | Kubernetes 版本 `1.27`, `1.28`   |
| Istio 从 1.18 升级到 1.22      | Kubernetes 版本 `1.27`           |

**注意**：

- 表中仅描述了 Istio 和 Kubernetes 的主要版本，次要版本不影响兼容性。
- 您可以在 **组件** 列表中查看集群当前运行的 Istio 和 Kubernetes 版本。
- 如果集群当前的 Kubernetes 版本低于 Istio 升级所需版本，则需要通过 [升级组件]() 将 Kubernetes 升级到兼容版本。
- 有关更多信息，请参阅 [社区支持的 Kubernetes 版本与 Istio](https://istio.io/latest/docs/releases/supported-releases/)。

### 升级过程

完整的服务网格升级流程包括以下步骤：

1. [升级集群中服务网格的非 Istio 组件](#component)，例如 asm 操作员、flagger 操作员等。
2. [在集群中部署新版本的 istiod](#newistiod)。
3. [检查集群中是否存在 EnvoyFilters](#envoyfilters)。
4. [升级集群中所有 Istio 数据平面](#data-planes)。
5. [退役集群中旧版本的 istiod](#oldistiod)。

### 升级操作

#### <span id="component">升级集群中服务网格的非 Istio 组件</span>

1. 在 **平台管理** 左侧导航中，点击 **服务网格** > **网格**。
2. 单击需要升级的 `服务网格名称` 以进入网格详细信息。
3. 在网格详细信息的 **网格部署** 区域，列出了已部署服务网格的集群。单击 `集群名称` 以在新标签页中打开集群详细信息页面。
4. 切换到集群详细信息页面的 **组件**，点击升级以将集群中服务网格的非 Istio 组件升级到最新版本。有关升级组件的详细文档，请参阅 [升级组件]()。

**注意**：服务网格的非 Istio 组件包括 asm、Flagger 操作员、Asm 操作员、Jaeger 操作员。

#### <span id="newistiod">部署新版本的 istiod</span>

**注意**：在部署新版本的 istiod 之前，请参阅 [升级前准备](#ref) 以确保集群的 Kubernetes 版本符合升级路径要求。

1. 返回到网格详细信息页面，在 **网格部署** 区域，点击对应集群的 `Istio 版本` 右侧的 **升级** 按钮。将会在弹出的窗口中显示 Istio 的升级路径。
2. 点击弹出窗口中的 **升级** 按钮。

#### <span id="envoyfilters">检查集群中是否存在 EnvoyFilters</span>

1. 在 **平台管理** 左侧导航中，点击 **服务网格** > **EnvoyFilter**。

   **注意**：如果平台上存在多个服务网格，您可以通过顶部导航栏切换到集群所在的服务网格。

2. 检查 EnvoyFilter 列表中是否有数据。
   - 如果未找到数据，则检查完成。
   - 如果找到数据，请联系 EnvoyFilter 创建者以将所有 EnvoyFilters 适配到新的 Istio 版本，或联系技术支持。

#### <span id="data-planes">升级集群中所有 Istio 数据平面</span>

集群中的 Istio 数据平面包括 Sidecars、入口网关和出口网关。

**方法 1：通过交互式命令行工具升级**

交互式命令行工具可以批量升级集群中的所有 Sidecars 和网关。此方法适合熟悉命令行操作的用户，尤其是需要快速对整个集群进行升级的用户。

```bash
kubectl -ncpaas-system exec -it deploy/asm-controller -- /app/asm-controller bfg rollout
```

**注意**：您也可以使用快速升级参数而不需要确认来执行升级。

```bash
kubectl -ncpaas-system exec -it deploy/asm-controller -- /app/asm-controller bfg rollout --no-prompt
```

**注意**：入口和出口网关的滚动升级过程涉及先删除旧 Pods，然后创建新 Pods，直到所有 Pods 更新到新的数据平面镜像版本。因此，如果网关只有一个 Pod，在网关升级期间将无法访问。

**方法 2：通过 UI 升级**

通过 UI 升级允许按不同命名空间进行批量升级或指定单个服务/网关进行升级。此方法适合希望在可视化界面中操作的用户，尤其是那些需要灵活选择升级目标的用户。

**升级入口和出口网关**

1. 在左侧导航栏中，点击 **服务网格** > **网关**。
   **注意**：在集群的网关列表中，**Istio 版本** 右侧的 ![](/zh/img/00feature.png) 图标表示网关的数据平面代理可以进行升级。
2. 单击 **Istio 版本** 右侧的 **升级** 按钮，并 **确认**。

**升级 Sidecars**

1. 在 **平台管理** 左侧导航中，点击 **服务网格** > **网格**。
2. 单击需要升级 Sidecars 的 `服务网格名称` 以进入网格详细信息。
3. 在网格详细信息的 **命名空间** 区域，有服务网格管理的命名空间列表。单击 `命名空间名称` 在新标签页中打开 **服务网格** 并进入包含 Sidecar 的命名空间。
   **注意**：按顺序对所有命名空间进行 Sidecar 升级。
4. 在左侧导航栏中，点击 **服务列表**。
   **注意**：当 `服务名称` 旁边出现 ![](/zh/img/00feature.png) 图标时，表示该服务的 Sidecar 可以升级。
5. 点击 **批量升级 Sidecars**。
   **注意**：点击服务记录右侧的 ![](/zh/img/00feature.png) 图标的 **升级** 按钮以升级单个服务。
6. 选择所有、一个或多个服务，然后点击 **升级**。
   **注意**：平台将通过滚动更新副本集中的 Pods，以不同的当前和目标版本升级服务的 Sidecar。如果升级失败，请检查容器平台中的容器组事件以了解故障原因，或尝试 **重新升级**。

**注意**：通过滚动更新服务的 Deployment 来更新 Sidecar，以完成 Pod 的数据平面镜像更新。因此，如果服务有长连接，则在 Pod 的滚动更新期间会短暂中断服务。

#### <span id="oldistiod">退役集群中的旧版本 istiod</span>

只有在集群中所有 Istio 数据平面升级完成后，才能退役集群中的旧版本 istiod。

**注意事项**：

- 如果不退役集群中的旧版本 istiod，您将无法使用服务网格的添加集群和 Sidecar 配置功能。
- 当平台上有新可升级版本时，如果有任何集群未退役旧版本的 istiod，平台将无法升级。
- 在多集群服务网格中，集群中的旧版本 istiod 只能在所有集群完成 Istio 数据平面升级后按顺序退役。

**步骤**

1. 返回到网格详细信息页面，在 **网格部署** 区域，点击对应集群的 **退役旧版本** 按钮，右侧的 `Istio 版本` 将弹出 **退役旧版本** 窗口。
2. 在弹出窗口中点击 **确认** 按钮。

**注意**：如果集群中有未升级的数据平面，在点击 **退役旧版本** 后，弹出窗口将显示集群中未升级的入口网关、出口网关和 Sidecars，快速跟踪待升级的数据平面。
