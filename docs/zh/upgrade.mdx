---
weight: 16
i18n:
  title:
    en: Upgrade
sourceSHA: f178b8a2b214801cc8b0199389718c88f418f7af3f949af7d275d971c2b47acd
title: 升级
---

作为平台（全球）进行升级时，请确保及时升级所有服务网格组件，以保持与服务网格相关功能的正常运行。

## <span id="ref">升级前的准备</span>

该平台为服务网格中的Istio提供了金丝雀升级，其中Istiod组件的新版本首先被部署。一旦所有数据平面完成升级，旧版本的Istiod组件将被停用。

鉴于Istio版本和Kubernetes版本之间的强依赖关系，请确保集群当前的Kubernetes版本满足Istio升级的要求，以成功完成金丝雀升级。

下表显示了当前平台版本的支持的Istio升级路径及其所需的Kubernetes版本。

| 支持的Istio升级路径        | Kubernetes版本要求      |
| --------------------------- | ----------------------- |
| 从Istio 1.20升级到1.22      | Kubernetes版本 `1.27`, `1.28` |
| 从Istio 1.18升级到1.22      | Kubernetes版本 `1.27`         |

**注意**：

- 表格中仅描述了Istio和Kubernetes的主要版本；次要版本不会影响兼容性。
- 您可以通过访问**组件**列表来检查集群中当前运行的Istio和Kubernetes版本。
- 如果集群当前的Kubernetes版本低于Istio升级所需版本，您需要通过[升级组件](@console-platform-docs/zh/platform-usermanual/clusterall/1cluster/11upgrade/)将Kubernetes升级到兼容版本。
- 有关更多信息，请参阅[社区支持的Kubernetes版本用于Istio](https://istio.io/latest/docs/releases/supported-releases/)。

## 升级过程

完整的服务网格升级过程包括以下步骤：

1. [升级集群中服务网格的非Istio组件](#component)，如asm operator、flagger operator等。
2. [在集群中部署新的Istiod版本](#newistiod)。
3. [检查集群中是否存在EnvoyFilters](#envoyfilters)。
4. [升级集群中所有的Istio数据平面](#data-planes)。
5. [停用集群中的旧版本Istiod](#oldistiod)。

## 升级操作

### <span id="component">升级集群中的非Istio组件</span>

1. 在**平台管理**左侧导航中，点击**服务网格** > **网格**。
2. 点击需要升级的`服务网格名称`以进入网格详情。
3. 在网格详情的**网格部署**区域，有一个已部署服务网格的集群列表。点击`集群名称`以在新标签页中打开集群详情页面。
4. 切换到集群详情页面的**组件**，并点击升级，以将集群中的非Istio组件升级到最新版本。有关升级组件的详细文档，请参阅[升级组件](@console-platform-docs/zh/platform-usermanual/clusterall/1cluster/11upgrade/)。

**注意**：服务网格的非Istio组件包括asm、Flagger Operator、Asm Operator、Jaeger Operator。

### <span id="newistiod">部署新的Istiod版本</span>

**注意**：在部署新的Istiod版本之前，请参阅[升级前的准备](#ref)，以确保集群的Kubernetes版本满足升级路径要求。

1. 返回到网格详情页面，在**网格部署**区域，点击相应集群的`Istio版本`右侧的**升级**按钮。弹出窗口将显示Istio的升级路径。
2. 点击弹出窗口中的**升级**按钮。

### <span id="envoyfilters">检查集群中是否存在EnvoyFilters</span>

1. 在**平台管理**左侧导航中，点击**服务网格** > **EnvoyFilter**。

   **注意**：如果平台上有多个服务网格，您可以通过顶部导航栏切换到集群所在的服务网格。

2. 检查EnvoyFilter列表中是否有数据。
   - 如果未找到数据，则检查完成。
   - 如果找到数据，请联系EnvoyFilter创建者以将所有EnvoyFilters调整为新的Istio版本，或联系技术支持。

### <span id="data-planes">升级集群中所有的Istio数据平面</span>

集群中的Istio数据平面包括Sidecars、入口网关和出口网关。

**方法1：通过交互式命令行工具升级**

交互式命令行工具可以批量升级集群中的所有Sidecars和网关。此方法适合熟悉命令行操作的用户，特别是那些需要快速升级整个集群的用户。

```bash
kubectl -ncpaas-system exec -it deploy/asm-controller -- /app/asm-controller bfg rollout
```

**注意**：您也可以使用不确认的快速升级参数执行升级。

```bash
kubectl -ncpaas-system exec -it deploy/asm-controller -- /app/asm-controller bfg rollout --no-prompt
```

**注意**：入口和出口网关的滚动升级过程涉及先删除旧的Pods，然后创建新的Pods，直到所有Pods都更新为新的数据平面镜像版本。因此，如果网关只有一个Pod，在网关升级期间将无法访问。

**方法2：通过UI升级**

通过UI升级允许通过不同的命名空间或指定单一服务/网关进行批量升级。此方法适合喜欢在可视化界面中操作的用户，尤其是那些需要灵活选择升级目标的用户。

**升级入口和出口网关**

1. 在左侧导航栏中，点击**服务网格** > **网关**。
   **注意**：在集群的网关列表中，**Istio版本**右侧的 ![](/zh/img/00feature.png) 图标表示网关的代理可以升级。
2. 点击**Istio版本**右侧的**升级**按钮，确认。

**升级Sidecars**

1. 在**平台管理**左侧导航中，点击**服务网格** > **网格**。
2. 点击需要升级Sidecars的`服务网格名称`以进入网格详情。
3. 在网格详情的**命名空间**区域，有一个服务网格管理的命名空间列表。点击`命名空间名称`以在新标签页中打开**服务网格**并进入Sidecar所在的命名空间。
   **注意**：请依次对所有命名空间进行Sidecar升级。
4. 在左侧导航栏中，点击**服务列表**。
   **注意**：当 ![](/zh/img/00feature.png) 图标出现在`服务名称`旁边时，表示该服务的Sidecar可以升级。
5. 点击**批量升级Sidecars**。
   **注意**：点击服务记录右侧的 ![](/zh/img/00feature.png) 图标的**升级**按钮可以升级单个服务。
6. 选择全部、一个或多个服务，然后点击**升级**。
   **注意**：平台将通过滚动更新具有不同当前和目标版本的Sidecar来升级服务的Sidecar。如果升级失败，请检查容器平台中的容器组事件以了解故障原因，或尝试**重新升级**。

**注意**：Sidecar通过服务的Deployment的滚动更新来完成Pod的数据平面镜像更新。因此，如果服务保持长连接，则在Pod的滚动更新期间会出现短暂的服务中断。

### <span id="oldistiod">停用集群中的旧版本Istiod</span>

集群中的旧版本Istiod只能在所有Istio数据平面完成升级后才能停用。

**注意**：

- 如果集群中的旧版本Istiod未被停用，您将无法使用服务网格的添加集群和Sidecar配置功能。
- 当平台上有新的可升级版本时，如果任何集群未停用旧版本Istiod，平台将无法升级。
- 在多集群服务网格中，集群中的旧版本Istiod只能在所有集群完成Istio数据平面升级后按顺序停用。

**步骤**

1. 返回网格详情页面，在**网格部署**区域，点击相应集群的`Istio版本`右侧的**停用旧版本**按钮。将显示**停用旧版本**弹出窗口。
2. 点击弹出窗口中的**确认**按钮。

**注意**：如果集群中有未升级的数据平面，点击**停用旧版本**后，弹出窗口将显示未升级的入口网关、出口网关和Sidecars，快速跟踪待升级的数据平面。
