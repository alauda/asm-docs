---
weight: 16
i18n:
  title:
    en: Upgrade service mesh
    zh: 升级服务网格
sourceSHA: cb7dca9b87fbbbaf1c45fcc3863bb52db8d8796acfcc22f2d94fdc8b03095485
---

:::tip

如果该父模块需要单独人工进行升级操作，则需要提供升级文档，否则可以不提供。

升级文档应包含升级流程、升级配置、回滚流程等。

如果不同版本升级流程存在较大差异，则需要将升级文档变成目录，并在该目录中提供不同版本的升级文档（例如：「3.10 升级指南」、「3.18 升级指南」）。

可以访问 [升级](https://product-doc-guide.alauda.cn/template/upgrade/example.html) 查看对应文档的示例。

:::

# 升级服务网格

随着平台（全球）升级，确保及时升级所有服务网格组件，以保持服务网格相关功能的正常运行。

## <span id="ref">升级前准备</span>

该平台为服务网格中的 Istio 提供了金丝雀升级，其中新版本的 istiod 组件会先行部署。一旦所有数据平面升级完成，旧版本的 istiod 组件将被停用。

鉴于 Istio 版本与 Kubernetes 版本之间的强依赖性，确保在升级 Istio 之前，集群的当前 Kubernetes 版本符合 Istio 升级要求，以成功完成金丝雀升级。

下表显示了当前平台版本支持的 Istio 升级路径及这些路径所需的 Kubernetes 版本。

| 支持的 Istio 升级路径        | Kubernetes 版本要求            |
| ----------------------------- | ------------------------------ |
| Istio 从 1.20 升级到 1.22     | Kubernetes 版本 `1.27`, `1.28` |
| Istio 从 1.18 升级到 1.22     | Kubernetes 版本 `1.27`         |

**注意**：

- 表格仅描述 Istio 和 Kubernetes 的主要版本；次要版本不会影响兼容性。
- 您可以通过访问 **组件** 列表检查集群中当前运行的 Istio 和 Kubernetes 版本。
- 如果集群当前的 Kubernetes 版本低于 Istio 升级所需的版本，您需要通过 [升级组件todo]() 将 Kubernetes 升级到兼容版本。
- 有关更多信息，请参阅 [社区支持的 Kubernetes 版本对于 Istio](https://istio.io/latest/docs/releases/supported-releases/)。

## 升级流程

完整的服务网格升级过程包括以下步骤：

1. [升级集群中服务网格的非 Istio 组件](#component)，例如 asm operator、flagger operator 等。
2. [在集群中部署新版本的 istiod](#newistiod)。
3. [检查集群中是否有 EnvoyFilters](#envoyfilters)。
4. [升级集群中的所有 Istio 数据平面](#data-planes)。
5. [停用集群中的旧版本 istiod](#oldistiod)。

## 升级操作

### <span id="component">升级集群中服务网格的非 Istio 组件</span>

1. 在 **平台管理** 左侧导航中，点击 **服务网格** > **网格**。
2. 点击需要升级的 `服务网格名称` 以进入网格详情。
3. 在网格详情的 **网格部署** 区域，您将看到服务网格已部署的集群列表。点击 `集群名称` 以在新标签页中打开集群详情页面。
4. 切换到集群详情页面的 **组件**，点击升级以将集群中服务网格的非 Istio 组件升级到最新版本。有关升级组件的详细文档，请参阅 [升级组件](@console-platform-docs/zh/platform-usermanual/clusterall/1cluster/11upgrade/)。

**注意**：服务网格的非 Istio 组件包括 asm、Flagger Operator、Asm Operator、Jaeger Operator。

### <span id="newistiod">部署新版本的 istiod</span>

**注意**：在部署新版本的 istiod 之前，请参阅 [升级前准备](#ref) 以确保集群的 Kubernetes 版本符合升级路径要求。

1. 返回到网格详情页面，在 **网格部署** 区域，点击对应集群的 `Istio 版本` 右侧的 **升级** 按钮。将弹出显示 Istio 的升级路径。
2. 点击弹出框中的 **升级** 按钮。

### <span id="envoyfilters">检查集群中是否有 EnvoyFilters</span>

1. 在 **平台管理** 左侧导航中，点击 **服务网格** > **EnvoyFilter**。

   **注意**：如果平台上有多个服务网格，您可以通过顶部导航栏切换到集群所在的服务网格。

2. 检查 EnvoyFilter 列表是否有数据。
   - 如果未找到数据，则检查完成。
   - 如果找到数据，请联系 EnvoyFilter 的创建者，将所有 EnvoyFilters 适配至新版本的 Istio，或联系技术支持。

### <span id="data-planes">升级集群中的所有 Istio 数据平面</span>

集群中的 Istio 数据平面包括 Sidecar、入口网关和出口网关。

**方法 1：通过交互式命令行工具升级**

交互式命令行工具可以批量升级集群中的所有 Sidecar 和网关。此方法适合熟悉命令行操作的用户，特别是需要快速升级整个集群的用户。

```bash
kubectl -ncpaas-system exec -it deploy/asm-controller -- /app/asm-controller bfg rollout
```

**注意**：您还可以使用无确认的快速升级参数执行升级。

```bash
kubectl -ncpaas-system exec -it deploy/asm-controller -- /app/asm-controller bfg rollout --no-prompt
```

**注意**：入口和出口网关的滚动升级过程需先删除旧的 Pods，然后创建新的 Pods，直至所有 Pods 更新至数据平面镜像的新版本。因此，如果网关只有一个 Pod，则在升级过程中将无法访问该网关。

**方法 2：通过 UI 升级**

通过 UI 升级可按不同命名空间批量升级或指定单个服务/网关进行升级。此方法适合那些喜欢在可视界面中操作的用户，特别是需要灵活选择升级目标的用户。

**升级入口和出口网关**

1. 在左侧导航栏中，点击 **服务网格** > **网关**。
   **注意**：在集群的网关列表中，**Istio 版本** 右侧的 ![](/zh/img/00feature.png) 图标表示该网关的数据平面代理可以升级。
2. 点击 **Istio 版本** 右侧的 **升级** 按钮，然后 **确认**。

**升级 Sidecars**

1. 在 **平台管理** 左侧导航中，点击 **服务网格** > **网格**。
2. 点击需要升级 Sidecars 的 `服务网格名称` 以进入网格详情。
3. 在网格详情的 **命名空间** 区域，您将看到由该服务网格管理的命名空间列表。点击 `命名空间名称` 打开 **服务网格** 的新标签，并进入包含 Sidecar 的命名空间。
   **注意**：对所有命名空间执行 Sidecar 升级时，请依次进行。
4. 在左侧导航栏中，点击 **服务列表**。
   **注意**：当 `服务名称` 旁边出现 ![](/zh/img/00feature.png) 图标时，表示该服务的 Sidecar 可以升级。
5. 点击 **批量升级 Sidecars**。
   **注意**：点击服务记录右侧 ![](/zh/img/00feature.png) 图标的 **升级** 按钮以升级单个服务。
6. 选择所有、一个或多个服务，然后点击 **升级**。
   **注意**：平台将通过逐滚更新具有不同当前和目标版本的 Sidecar 的 Pods 来完成服务的 Sidecar 升级。如果升级失败，请检查容器平台中的容器组事件以了解故障原因，或尝试 **重新升级**。

**注意**：Sidecar 通过服务 Deployment 的滚动更新来完成 Pod 的数据平面镜像更新。因此，如果该服务存在长连接，在 Pods 的滚动更新过程中会有短暂的服务中断。

### <span id="oldistiod">停用集群中的旧版本 istiod</span>

集群中的旧版本 istiod 只能在所有 Istio 数据平面升级完成后才可停用。

**注意**：

- 如果集群中的旧版本 istiod 未被停用，您将无法使用服务网格的添加集群和 Sidecar 配置功能。
- 当平台上有新的可升级版本时，如果任何集群尚未停用旧版本 istiod，平台将无法升级。
- 在多集群服务网格中，集群中的旧版本 istiod 只能在所有集群完成 Istio 数据平面升级后依次停用。

**步骤**

1. 返回网格详情页面，在 **网格部署** 区域，点击对应集群的 `Istio 版本` 右侧的 **停用旧版本** 按钮。将弹出 **停用旧版本** 对话框。
2. 点击弹出框中的 **确认** 按钮。

**注意**：如果集群中有尚未升级的数据平面，在点击 **停用旧版本** 后，弹出框将显示集群中尚未升级的入口网关、出口网关和 Sidecars，方便快速跟踪需要升级的数据平面。
