---
title: Trace 查询中常见问题
description: 本文讨论了查询追踪数据时可能遇到的常见问题。
weight: 300
sourceSHA: 128bb5e9b6eb96dab178a428354fbaf9648277f4edcafe1cd452302eb73fc382
---

## 为什么我找不到所需的追踪数据？

### 1. 追踪采样率过低

如果你的服务网格中的追踪采样率设置过低，可能仅在请求量充足时才能看到追踪数据。

你可以根据需要提高采样率。

### 2. 查询非常近期的追踪数据

在查询最近时间段（例如，过去 30 分钟）的追踪数据时，如果追踪结果未包含过去 10 秒的数据，这种情况是正常的。你可以稍等片刻，然后刷新页面再试。

这是因为追踪数据存储在 Elasticsearch 中，该系统提供近乎实时的搜索能力。

此外，ASM 在 Elasticsearch 中配置的追踪索引默认设置为 `"refresh_interval": "10s"`，这意味着 Elasticsearch 每 10 秒将内存中的数据刷新到磁盘上，之后数据才可被搜索。

此索引配置有效减少了 Elasticsearch 的数据合并压力，提高了索引速度和初始查询性能，但也略微降低了数据的实时性。

你可以通过在 `jaeger-collector` 的启动参数中使用 `--es.asm.index-refresh-interval` 来调整此配置。默认值为 `10s`。

如果该参数被设置为 `"null"`，则不会配置索引的 `refresh_interval`。

### 3. 查询条件设置不当

在执行追踪查询时，如果对 `Span kind` 参数背后的技术原理理解不够透彻，可能导致不返回任何数据。因此，不建议随意使用此参数。特别是同时指定 `Client` 和 `Server` 时，可能会导致查询结果为空。

#### 示例 1：`Span kind` 设置为 `Root Span` 且同时指定 `Client` 和 `Server`

在这种情况下，查询将返回 **没有数据**。原因是当客户端和服务器都由 OTel Agent 管理时，追踪的根跨度通常在客户端，而无法获取服务器数据。为解决此问题，请移除 `Server` 条件或避免选择 `Root Span`。

#### 示例 2：`Span kind` 设置为 `Service Entry Span` 且同时指定 `Client` 和 `Server`

类似地，此查询也将返回 **没有数据**。原因是当客户端和服务器都注入了 Sidecar 时，`Service Entry Span` 指的是服务器接收到的第一个请求，但追踪数据存储在客户端。为解决此问题，请移除 `Client` 条件或避免选择 `Service Entry Span`。

## 查询的追踪结果为何不完整？

### 1. 当前时间段的追踪数据不完整

在查询最近时间段（例如，过去 30 分钟）的追踪数据时，如果追踪中的跨度不完整，这是正常现象。你可以稍等片刻，然后刷新页面再试。

这是因为当 Elasticsearch 正在将最新的跨度刷新到磁盘时，一些跨度可能尚未生成或写入磁盘，从而导致追踪结果不完整。

### 2. 长持续时间跨度的追踪不完整

如果查询的追踪具有较长的持续时间（例如，跨越超过一小时），返回不完整的数据是正常的。

默认情况下，当 ASM 查询某个跨度的追踪时，时间范围会延长跨度开始和结束时间各一小时。

例如，如果一个跨度在 08:12:30 开始并在 08:12:32 结束，该追踪的查询时间范围将是从 07:12:30 到 09:12:32。

因此，如果追踪超过一小时，通过该跨度查询可能无法获取完整的追踪数据。

如果你所在环境中的追踪通常持续时间较长，可以使用 `--es.asm.span-trace-query-time-adjustment-hours` 启动参数来调整单个追踪的查询时间范围。

此参数的默认值为一小时，但你可以根据需要进行增加。
