---
weight: 15
title: 创建服务网格
sourceSHA: 7827241892b7da4ee73a9cfec85ad709372b29ffd2cf0ceed67628918a8e3bb8
---

本文档说明如何创建单集群服务网格。在继续之前，请确保您熟悉以下主题：

- \[网格部署模型]\({{< relref "mesh-u-servicemesh/create-servicemesh/mesh-deploy-model.md" >}}): 选择适合您需求的网格部署模型。
- \[网格组件描述]\({{< relref "mesh-u-servicemesh/create-servicemesh/component-descriptions.md" >}}): 了解网格组件的角色，并为服务网格准备必要的 CPU 和内存资源。

有关如何创建多集群服务网格的说明，请参阅 \[多集群服务网格]\({{< relref "mesh-u-servicemesh/multicluster-mesh" >}}) 文档。

## 约束与限制

- 每个集群仅允许一个服务网格。
- 当集群为 global 集群且平台处于灾难恢复环境（即 global 拥有一个主集群和一个灾难恢复集群）时，global 集群无法部署服务网格。
- 当集群为 IPv4/IPv6 双栈网络时，无法部署服务网格。

## 前提条件

下载与您的平台架构对应的 Alauda 服务网格操作员安装包。

通过上传包机制上传 Alauda 服务网格操作员安装包。

确保集群已部署 Prometheus 插件或 VictoriaMetrics 插件。

**注意：** 当 VictoriaMetrics 为多集群部署架构时，`vmstorage` 可以与服务网格位于不同的集群中。

确保有可用的 Elasticsearch。服务网格可以与集群的 Elasticsearch 日志记录插件接口或您自己的 Elasticsearch 接口。

当集群为 **OpenShift** 集群时，还必须满足以下前提条件：

- 已创建命名空间 `istio-system`。
- 将 `istio-system` 命名空间添加到 `anyuid` SCC（安全上下文约束）组中。为此，请登录到 OpenShift 集群的堡垒主机并执行以下命令：
  ```shell
  oc adm policy add-scc-to-group anyuid system:serviceaccounts:istio-system
  ```

## 步骤

1. 在左侧导航栏中，单击 **服务网格** > **网格**。
2. 单击 **创建服务网格**。
3. 选择要部署服务网格的集群和 Istio 版本。在高级配置中，确保网格架构为单集群，并填写 Elasticsearch 和监控系统的接口参数。您可以选择平台的现有系统或外部系统。
   - 如果严格要求高可用性，请将 Pod 反亲和性设置为强制。
   - 组件资源可以使用默认值，但随着网格中服务规模的增长，组件将需要扩展。及时配置网格组件的警报策略，以便在需要扩展时获得通知。

有关更多信息，请参见 [网格参数描述](#mesh_parm_desc)

**注意**：当集群为 **OpenShift** 集群时，网格将自动检测并默认部署 `istio-cni` 组件。

## 后续步骤

- \[启用 Istio CNI]\({{< relref "mesh-u-servicemesh/create-servicemesh/istio-cni.md" >}})，以消除每个 Pod 中对特权初始化容器的需求。
- \[启用全局速率限制]\({{< relref "mesh-u-servicemesh/create-servicemesh/global\_rate\_limit.md" >}})。
- \[使用 Istioctl 工具]\({{< relref "mesh-u-servicemesh/create-servicemesh/istioctl.md" >}})。
- \[监控网格组件]\({{< relref "mesh-u-servicemesh/create-servicemesh/monitoring\_component.md" >}})。

## <span id="mesh_parm_desc">网格参数描述</span>

### 全局配置

网格的全局配置将应用于所有网格已部署的集群。

| 参数                                 | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **与 Elasticsearch 接口**           | **平台**：与平台任意集群上的 Elasticsearch 日志记录插件接口。选择 Elasticsearch 日志记录插件所在的集群。<br>**外部**：与外部 Elasticsearch 日志记录插件接口。用户需要配置以下参数：<br>**访问地址**：Elasticsearch 的访问地址，需以 `http://` 或 `https://` 开头。<br>**认证方式**：访问 Elasticsearch 的认证方式。<br>- **基本认证**：输入用于身份验证的用户名和密码。<br>- **无认证**：无须进行身份验证即可访问。                                                                                                                                                                                                                                            |
| **与监控系统接口**                   | **平台**：与集群中的 Prometheus 插件或 VictoriaMetrics 插件接口。<br>**外部**：与外部插件提供的 Prometheus 或 VictoriaMetrics 接口。用户需要配置以下参数：<br>**数据查询地址**：监控组件的数据查询地址，需以 `http://` 或 `https://` 开头。<br>**认证方式**：访问监控系统的认证方式。<br>- **基本认证**：输入用于身份验证的用户名和密码。<br>- **无认证**：无须进行身份验证即可访问。<br>**注意**：由于 Prometheus 插件无法聚合来自多个集群的监控数据，因此该集群下的服务网格无法添加更多集群以形成多集群服务网格。 |

### 集群维度配置

集群维度配置仅适用于所选集群。

| 参数                           | 描述                                                                                                                                                                                                                                                                                                     |
| ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **边车配置**                  | **资源配额**：边车资源配额的默认值在集群级别。可以根据实际情况在为特定服务注入边车时进行修改，但不得超过边车所在命名空间容器配额（LimitRange）的最大限制。                                                                                                                                                                             |
| **跟踪配置**                  | **采样率**：边车跟踪的默认采样率在集群级别。                                                                                                                                                                                                                                                              |
| **Redis 配置**                | 仅在数据平面中使用 **全局速率限制** 功能时必须配置。有关具体配置方法，请参阅 \[启用全局速率限制]\({{< relref "mesh-u-servicemesh/create-servicemesh/global\_rate\_limit.md" >}})。                                                                                                                  |
| **HTTP 重试策略**            | **重试次数**：在集群级别 HTTP 的默认最大重试次数。<br>**注意**：在服务路由的 **超时和重试** 策略中的 **重试次数** 将覆盖此默认值。                                                                                                                                                                        |

### 组件配置

**注意**：网格组件以部署的形式在集群的特定命名空间中部署。网格成功创建后，您可以在 **组件** 标签中查看组件的运行状态，或者单击 **组件名称** 进入组件在容器平台上部署的命名空间并查看运行组件的 Deployment 的详细信息。

| 参数                              | 描述                                                                                                                                                                                                                                                                                                                                                                           |
| --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Pod 反亲和性**                | Kubernetes 将根据 **Pod 反亲和性** 设置将组件 Pods 调度到满足的节点。<br>**强制**：同一组件的 Pods 只能在同一节点上运行一个。<br>**优先**：允许同一组件的多个 Pods 在同一节点上运行。Kubernetes 将尝试根据调度算法将组件的 Pods 均匀调度到可用节点上，但不能保证每个节点上都有组件 Pods。                                                  |
| **实例数量**                    | 预期运行的组件 Pods 的数量，根据实际业务请求量进行设置。                                                                                                                                                                                                                                                                                                                 |
| **资源配额**                    | 组件创建时每个容器实例的资源（CPU、内存）请求值（requests），也是容器的可用资源的限制值（limits）。根据实际业务量和实例数量合理设置。                                                                                                                                                                                                                                                                                |
| **部署节点**                    | 组件被部署的节点。创建网格时，组件的 Pods 只能调度到所选节点。                                                                                                                                                                                                                                                                                                                 |
| **ELB**                          | 用于提供 CCE 集群上 Istio Gateway 的负载均衡能力的华为云弹性负载均衡器（ELB）。当选定集群为 CCE 集群时，您需要填写 **ELB ID** 和 **ELB 类型**，以关联为集群提前准备好的 ELB。                                                                                                                                                                                                                  |
| **总资源**                      | 根据当前配置创建组件所有容器实例所需的总资源（CPU、内存）配额。当启用组件的自动扩展时，将根据最大实例数量进行计数。                                                                                                                                                                                                                                                                  |
