---
weight: 13
title: 如何自定义和应用对 Istio 资源的配置更改？
description: 本文将指导您如何在平台上自定义和应用对 Istio 资源的更改，从而启用平台 UI 中未提供的功能。
sourceSHA: e98428e43d88a0abd42b2b2f38d3d71de869a4a92c0a3f0b31d681acabd42dcd
---

## 概述

### 背景信息

该平台通过封装 CRD 或操作 Istio 资源（DestinationRule、VirtualService 等）提供 Istio 功能。在平台上操作（添加、删除、修改）Istio 资源的方法包括：

- 用户在平台 UI 上执行操作。

  - 在特定功能页面执行操作。例如，在服务详情页面的 **Routes** 标签页中，通过 **Create Route** 创建虚拟服务资源。

  - 直接在集群的 **Resources** 页面编辑 Istio 资源的 YAML 文件。管理员可以对 Kubernetes 资源（包括 Istio 资源）进行创建、修改或删除 YAML 操作。

- 服务网格组件 Controller（global-asm-controller/asm-controller）根据 CRD 或 API 自动调整，并在调整过程中，Controller 会自动更新 Istio 资源。

  例如，通过 UI 为平台上的服务创建负载均衡策略后，Controller 会自动创建相应的 DestinationRule 资源；反之，在删除负载均衡策略后，Controller 会自动删除相应的 DestinationRule 资源。

### 解决方案概述

当产品 UI 的功能未满足您的期望与原生 Istio 支持时，您可以参考本文档在 **Platform Management** > **Clusters** > **Resources** 页面上自定义并应用对 Istio 资源 YAML 文件的更改，临时利用原生 Istio 提供的功能。

自定义和应用对 Istio 资源配置更改的方法如下：

1. 向 Istio 资源添加注释 `asm.cpaas.io/user-managed: "true"`，以使其脱离 Controller 的控制，从而避免 Controller 组件恢复或修改自定义更改。

2. 根据 [Istio](https://istio.io/latest/docs/reference/config/) 提供的配置参考自定义 YAML 配置。

## 限制与限制条件

- 使用此方法配置的 Istio 资源将不再由 Controller 组件控制，需由用户手动管理。

- 如果修改后的 YAML 配置不符合 Istio 的设计，可能会出现影响功能的未定义问题。

- 当您将来升级到新版本的 Istio 时，平台将不处理未管理资源的兼容性升级。您需要自行评估兼容性并进行兼容性处理。

## 配置示例

以下我们将使用修改 DestinationRule 资源的场景，以为服务的多个端口配置不同的负载均衡策略来说明配置方法。

### 场景

服务 s1 有 2 个端口 `80`（HTTP 协议）和 `81`（TCP 协议）。通过 UI 为该服务创建负载均衡策略时，仅支持为所有端口配置相同的策略（例如，最少请求负载均衡）。您可以修改 s1 的 DestinationRule 资源，分别为端口 `80` 和 `81` 配置不同的负载均衡策略。

### 步骤

1. 进入服务网格平台后，点击左侧导航栏的 **Services**。

2. 点击要配置的 ***service name***。

3. 在 **Policies** 标签下，点击 **Create Policy** > **Load Balancer**。

4. 选择 **Minimum Request Load** 策略后，点击 **Create**。

   **提示**：成功创建负载均衡策略后，Controller 组件将自动创建一个名为 `asm-<service name>` 的 DestinationRule 资源。您可以在 **Resources** 中查看该资源的 YAML 文件。

5. 点击顶部导航栏中的产品视图切换入口，切换到 **Platform Management**。

6. 在左侧导航栏中，点击 **Clusters** > **Resources**。

   **提示**：您可以通过顶部导航切换集群。

7. 在服务所在的命名空间中，搜索名为 `asm-<service name>` 的 DestinationRule 资源。

8. 点击 <img src="/zh/003point.png" alt="003point" style={{display: "inline"}} /> > DestinationRule 右侧的 **Update**。

   参考以下示例，添加注释 `asm.cpaas.io/user-managed: "true"`，并为服务的端口分别配置 [负载均衡策略](https://istio.io/latest/docs/reference/config/networking/destination-rule/)。

   ```yaml
   apiVersion: networking.istio.io/v1alpha3
   kind: DestinationRule
   metadata:
     annotations:
       asm.cpaas.io/user-managed: "true"  # 添加注释
       cpaas.io/operator: admin@cpaas.io
       cpaas.io/updated-at: 2024-03-08T03:17:00Z
     creationTimestamp: 2024-03-07T10:22:11Z
     generation: 2
     labels:
       asm.cpaas.io/creator: asm-controller
       asm.cpaas.io/hostname: s1
       servicemesh.cpaas.io/resource: microservice
     name: asm-s1
     namespace: foo-ovn
     ownerReferences:
       - apiVersion: v1
         kind: Endpoints
         name: s1
         uid: b8ae24ba-b0ae-4432-a42c-09619a798963
     resourceVersion: "24795213"
     uid: 99fddf65-4812-4948-a92b-62de33fa3b4f
   spec:
     host: s1
     trafficPolicy:
       loadBalancer:
         simple: LEAST_CONN  # 默认对所有服务端口使用最少请求负载均衡策略
       portLevelSettings: # 针对端口 81 根据用户源 IP 配置会话亲和性负载均衡策略
         - loadBalancer:
             consistentHash:
               useSourceIp: true
           port:
             number: 81
   ```
