---
weight: 10
sourceSHA: 50ce56d58f955e499d7270b93034d9ef4fb11c48f788f6fe8f40668a7ef5fa59
---

# Использование канарейного релиза

## Введение

Канарейный релиз позволяет контролируемо развертывать обновления сервисов с помощью постепенного переноса трафика и мониторинга в реальном времени. Эта функциональность:

- Снижает риски развертывания в рабочей среде
- Поддерживает несколько стратегий релиза (канарейный/синий-зеленый/A/B тестирование)
- Обеспечивает автоматические механизмы отката
- Интегрируется с рабочими процессами GitOps

Основная ценность: Безопасное и наблюдаемое обновление версий сервиса

## Возможности

- Режимы управления трафиком: ручной/автоматический
- Правила маршрутизации на основе заголовков/путей
- Метрики успешности в реальном времени/задержки
- Конфигурация на основе CRD для GitOps

## Преимущества

**Точное управление**: Деление трафика с гранулярностью 1%  
**Наблюдаемость**: Интегрированная панель мониторинга  
**Безопасность**: Авто-откат при превышении порогов ошибок  
**Соответствие**: Соблюдение политик безопасности во время релиза  

## Включение канарейного релиза

### Шаг 1: Получение доступа к конфигурации сервиса

1. Перейдите в: **Список сервисов** > **Целевой сервис**
2. Выберите вкладку **Канарейный релиз**
3. Нажмите **Включить** в разделе Конфигурация релиза

### Шаг 2: Настройка параметров релиза

```yaml
analysis:
  interval: 2m
  maxWeight: 50
  stepWeight: 10
  threshold: 10
maxResponseTime: 500
minSuccessRate: 95
```

| Параметр   | Обязательно | По умолчанию | Описание                  |
|------------|-------------|--------------|---------------------------|
| interval   | Да          | 2m           | Интервал смещения трафика |
| maxWeight  | Да          | 50%          | Порог повышения           |
| threshold  | Да          | 10           | Максимально допустимые ошибки |

## Управление конфигурацией маршрутизации

### Распределение трафика

```yaml
http:
• route:
  • destination: reviews-primary
    weight: 80
  • destination: reviews-canary
    weight: 20
```

### Маршрутизация на основе заголовков

```yaml
• match:
  • headers: { "user-type": "internal" }
  route:
    ◦ destination: reviews-canary
```

### Тестирование для конкретного пути

```yaml
• match:
  • uri: { prefix: "/api/v2" }
  route:
    ◦ destination: reviews-canary
      weight: 20
```

## Справочник CRD для CanaryDelivery

### Требования к метаданным

| Поле       | Ограничение                | Пример   |
|------------|----------------------------|----------|
| name       | Должно совпадать с именем сервиса | reviews  |
| namespace  | Должно совпадать с пространством имен сервиса | prod |

### Подробности спецификации

```yaml
spec:
  delivertype: canary
  targetRef:
    name: reviews-v1
  trafficControl: system
```

| Поле           | Допустимые значения | Описание                  |
|----------------|---------------------|---------------------------|
| promoteControl  | user/system         | Режим подтверждения релиза |
| trafficControl  | user/system         | Режим управления трафиком  |

## Мониторинг и проверка

### Ключевые метрики

| Метрика       | Расчет                | Порог       |
|---------------|-----------------------|-------------|
| Успешность    | 2xx/Total             | >95%        |
| Задержка      | avg(response\_time)   | \<500ms     |
| Ошибки        | 5xx count             | \<10/период |

### Состояния релиза

1. Инициализация ➔ 2. Прогресс ➔ 3. Продвижение ➔ 4. Завершено

```bash
kubectl get canarydeliveries -n prod
```

## Операционные ограничения

- Несовместимость с существующей маршрутизацией сервиса
- Требуется уникальное именование сервисов для каждого кластера
- Сервисы, управляемые GitOps, имеют ограниченные элементы управления в интерфейсе
- Политики безопасности остаются активными во время релиза
