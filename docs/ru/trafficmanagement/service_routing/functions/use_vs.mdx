---
weight: 10
sourceSHA: 00563b96faf91f4629e44c1af8edfef50332fd1036236c473b648846a8199d26
---

# Маршрутизация сервисов

## Введение

Маршрутизация сервисов позволяет точно контролировать поток трафика между сервисами с помощью правил на основе Istio. Эта функциональность:

- Управляет распределением запросов между сервисами
- Поддерживает сложные сценарии разделения трафика
- Реализует механизмы восстановления после сбоев
- Предоставляет возможности ненавязчивого тестирования

Основное значение: Обеспечивает детализированное управление трафиком для архитектур микросервисов

## Функции

- Условная маршрутизация на основе 6 атрибутов запроса
- Распределение трафика на основе веса
- 5 продвинутых политик трафика
- Поддержка маршрутизации между кластерами

## Преимущества

**Точность**: 1% детализированный контроль трафика  
**Гибкость**: Соответствие по заголовкам/URI/источнику  
**Безопасность**: Встроенные механизмы разрыва цепи  
**Наблюдаемость**: Интеграция с метриками мониторинга  

## Конфигурация правил маршрутизации

### Типы правил

```yaml
http:
- match:
  - headers:
      user-type: internal
  route:
    ◦ destination:
        host: staging-service
      weight: 100
```

| Тип       | Приоритет | Поля сопоставления       |
| --------- | -------- | ------------------------- |
| Условие   | Высокий  | URI/Заголовки/Метки источников |
| Вес       | Низкий   | Распределение по процентам |

### Спецификации параметров

| Параметр   | Ограничения  | Пример          |
| -----------| ------------ | --------------- |
| Вес        | Сумма=100%   | v1:80%, v2:20%  |
| Соответствие с регулярным выражением | Синтаксис RE2 | `^/api/v\d+/`  |

## Управление политиками маршрутизации

### Типы политик

```yaml
retries:
  attempts: 3
  perTryTimeout: 2s
  retryOn: 5xx
```

| Политика          | Параметры                   | Совместимость    |
| ------------------| --------------------------- | ----------------- |
| Инъекция ошибок   | Уровень ошибок(10%), Код(400) | ❌ Зеркалирование   |
| Зеркалирование трафика | Целевой сервис, Порт       | ✔️ Перезапись     |
| Перезапись запроса | Хост/URI                   | Только правила веса |

### Расчет времени ожидания

```
Глобальное время ожидания (100ms) ≥
(Время ожидания повторной попытки (10ms) × (Повторные попытки (8) + 1))
→ Действительная конфигурация
```

## Процедура создания маршрута

### Предварительные требования

- Настроены порты протокола сервиса
- Отключен канарейный выпуск
- Включено кросс-кластерное обнаружение (по желанию)

### Пошаговая реализация

1. Перейдите: **Список сервисов** > **Целевой сервис**
2. Выберите **Маршрут** > вкладка **HTTP**
3. Нажмите **Создать маршрут** для каждого кластера

```yaml
# Пример конфигурации маршрута
- match:
  - uri:
      prefix: "/checkout"
  route:
    ◦ destination:
        host: payment-service
      weight: 100
    fault:
      delay:
        percentage: 5
        fixedDelay: 100ms
```

## Оперативные ограничения

1. **Ограничения протокола**:
   - TCP маршруты исключают продвинутые политики
   - gRPC требует конечные точки HTTP/2

2. **Система приоритетов**:
   - Правила условий выполняются сверху вниз
   - Правила веса обрабатывают неподходящий трафик

3. **Совместимость версий**:
   - Требуется Istio 1.6+ для соответствия регулярному выражению
   - Kubernetes 1.18+ для маршрутизации на основе меток
