---
weight: 13
title: Как настраивать и применять изменения конфигурации ресурсов Istio?
description: >-
  Эта статья поможет вам настроить и применить изменения к ресурсам Istio на
  платформе, позволяя включить функции, которые не предоставляются через
  графический интерфейс платформы.
sourceSHA: e98428e43d88a0abd42b2b2f38d3d71de869a4a92c0a3f0b31d681acabd42dcd
---

## Обзор

### Фоновая информация

Платформа предоставляет функции Istio через инкапсуляцию CRD или работу с ресурсами Istio (DestinationRule, VirtualService и др.). Способы работы (добавление, удаление, изменение) с ресурсами Istio на платформе включают:

- Пользователи выполняют действия через графический интерфейс платформы.

  - Выполнение операций на определенных функциональных страницах. Например, на вкладке **Маршруты** на странице деталей сервиса, создание ресурса виртуального сервиса с помощью **Создать маршрут**.

  - Прямое редактирование YAML-файла ресурсов Istio на странице **Ресурсы** кластера. Администраторы могут создавать, изменять или удалять YAML-операции по ресурсам Kubernetes, включая ресурсы Istio.

- Компонент сетевого меша Controller (global-asm-controller/asm-controller) автоматически настраивается в соответствии с CRD или API, и во время настройки Controller автоматически обновляет ресурсы Istio.

  Например, после создания политики балансировки нагрузки для сервиса на платформе через UI, Controller автоматически создает соответствующий ресурс DestinationRule; наоборот, после удаления политики балансировки нагрузки, Controller автоматически удаляет соответствующий ресурс DestinationRule.

### Обзор решения

Когда графический интерфейс продукта не соответствует вашим ожиданиям по функциональности и поддержке нативного Istio, вы можете обратиться к этому документу, чтобы настроить и применить изменения к YAML-файлам ресурсов Istio на странице **Управление платформой** > **Кластеры** > **Ресурсы**, временно используя функции, предоставляемые нативным Istio.

Метод настройки и применения изменений к конфигурациям ресурсов Istio выглядит следующим образом:

1. Добавьте аннотацию `asm.cpaas.io/user-managed: "true"` к ресурсам Istio, чтобы отвязать их от управления Controller, избегая восстановления или изменения пользовательских изменений компонентом Controller.

2. Настройте YAML-конфигурацию на основе справки по конфигурациям, предоставленной [Istio](https://istio.io/latest/docs/reference/config/).

## Ограничения и лимитации

- Ресурсы Istio, настроенные с использованием этого метода, больше не контролируются компонентом Controller и требуют ручного управления пользователями.

- Если измененная YAML-конфигурация не соответствует дизайну Istio, могут возникнуть неизвестные проблемы, влияющие на функциональность.

- Когда вы в будущем обновите до новой версии Istio, платформа не будет обрабатывать совместимость для неуправляемых ресурсов. Вам нужно будет самостоятельно оценить совместимость и произвести обработку совместимости.

## Пример конфигурации

Ниже мы рассмотрим сценарий изменения ресурса DestinationRule для настройки различных политик балансировки нагрузки для нескольких портов службы, чтобы проиллюстрировать метод конфигурации.

### Сценарий

Сервис s1 имеет 2 порта `80` (HTTP-протокол) и `81` (TCP-протокол). При создании политики балансировки нагрузки для сервиса через UI поддерживается только настройка одной и той же политики для всех портов (например, балансировка нагрузки с минимальной загрузкой запросов). Вы можете изменить ресурс DestinationRule для s1, чтобы настроить различные политики балансировки нагрузки для портов `80` и `81` соответственно.

### Процедура

1. После входа на платформу Service Mesh нажмите на **Сервисы** в левом навигационном меню.

2. Нажмите на ***название сервиса***, который нужно настроить.

3. На вкладке **Политики** нажмите на **Создать политику** > **Балансировщик нагрузки**.

4. После выбора политики **Минимальная загрузка запросов** нажмите **Создать**.

   **Совет**: После успешного создания политики балансировки нагрузки компонент Controller автоматически создаст ресурс DestinationRule с именем `asm-<название сервиса>`. Вы можете просмотреть YAML-файл этого ресурса на странице **Ресурсы**.

5. Нажмите на вход для переключения представления продукта в верхней навигационной панели, чтобы перейти к **Управлению платформой**.

6. В левом навигационном меню нажмите на **Кластеры** > **Ресурсы**.

   **Совет**: Вы можете переключать кластеры через верхнюю навигацию.

7. В пространстве имен, где находится сервис, найдите ресурс DestinationRule с именем `asm-<название сервиса>`.

8. Нажмите <img src="/en/003point.png" alt="003point" style={{display: "inline"}} /> > **Обновить** справа от DestinationRule.

   Ссылаясь на пример ниже, добавьте аннотацию `asm.cpaas.io/user-managed: "true"` и настройте [политики балансировки нагрузки](https://istio.io/latest/docs/reference/config/networking/destination-rule/) для портов сервиса отдельно.

   ```yaml
   apiVersion: networking.istio.io/v1alpha3
   kind: DestinationRule
   metadata:
     annotations:
       asm.cpaas.io/user-managed: "true"  # Добавьте аннотацию
       cpaas.io/operator: admin@cpaas.io
       cpaas.io/updated-at: 2024-03-08T03:17:00Z
     creationTimestamp: 2024-03-07T10:22:11Z
     generation: 2
     labels:
       asm.cpaas.io/creator: asm-controller
       asm.cpaas.io/hostname: s1
       servicemesh.cpaas.io/resource: microservice
     name: asm-s1
     namespace: foo-ovn
     ownerReferences:
       - apiVersion: v1
         kind: Endpoints
         name: s1
         uid: b8ae24ba-b0ae-4432-a42c-09619a798963
     resourceVersion: "24795213"
     uid: 99fddf65-4812-4948-a92b-62de33fa3b4f
   spec:
     host: s1
     trafficPolicy:
       loadBalancer:
         simple: LEAST_CONN  # По умолчанию используется политика балансировки нагрузки с минимальной загрузкой запросов для всех портов службы
       portLevelSettings: # Настройте политику балансировки нагрузки с учетом сессий пользователя по IP-адресу для порта 81
         - loadBalancer:
             consistentHash:
               useSourceIp: true
           port:
             number: 81
   ```
