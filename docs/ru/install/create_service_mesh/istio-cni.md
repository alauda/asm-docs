---
weight: 20
title: Включение Istio CNI
sourceSHA: 6dc1cbadf05066a8a986f44ae309eff3cfa0835b54951c444440f4dd46077e63
---

Узел-агент Istio CNI используется для настройки перенаправления трафика для Pod в сети. Он работает как DaemonSet на каждом узле с повышенными правами. Узел-агент Istio CNI можно использовать в двух режимах плоскости данных Istio.

В режиме плоскости данных Sidecar узел-агент Istio CNI является необязательным. Он исключает необходимость запуска привилегированных контейнеров инициализации в каждом Pod в сети, заменяя их на один привилегированный Pod-агент узла на каждом узле Kubernetes.

В режиме плоскости данных Ambient узел-агент Istio CNI обязателен.

Этот документ подробно описывает, как установить и включить Istio CNI для режима плоскости данных Sidecar.

**Примечание:** Если вы создаете mesh-сервис в кластере **OpenShift**, Istio CNI включен по умолчанию, поэтому вам не нужно следовать шагам в этом документе.

## Требования к окружению

**Окружения, которые должны использовать Istio CNI:**

- Huawei Cloud CCE
- Другие окружения, запрещающие использование разрешений NET\_ADMIN и NET\_RAW в бизнес-нагрузках (например, с жесткими настройками PodSecurityPolicy)

**Окружения, в которых можно использовать Istio CNI:**

- Любой кластер Kubernetes с включенной поддержкой CNI в теории

**Окружения, в которых нельзя использовать Istio CNI:**

- Кластеры с отключенной поддержкой CNI Kubernetes (редко, обычно встречаются в легковесных средах разработки Kubernetes, таких как KIND)

## Установка и конфигурация

Сначала установите mesh-сервис как обычно. После установки не добавляйте никакие услуги (т.е. не внедряйте Sidecar) на время. Затем следуйте шагам ниже для установки и настройки Istio CNI.

### Установка узла-агента Istio CNI

Измените ресурс ServiceMesh следующим образом:

```yaml
apiVersion: asm.alauda.io/v1alpha1
kind: ServiceMesh
spec:
  componentConfig:
    # Добавьте новый элемент:
    # (Установите плагин Istio CNI)
    - name: istioCni  # имя должно быть istioCni
      group: istio
      cni:
        namespace: kube-system  # обычно устанавливается в kube-system
        # значения: # обратитесь к описаниям в значениях кода Istio. Забронировано для настройки (особенно для Multus CNI, как показано в примере ниже)
          # cniBinDir: /opt/cni/bin  # обычно не настраивается
          # cniConfDir: /etc/cni/net.d
          # chained: false  # должно быть false для Multus CNI
          # cniConfFileName: "istio-cni.conf"
          # excludeNamespaces:
          #   - istio-system
          #   - kube-system
          # logLevel: info
          # privileged: true
          # provider: multus
```

**Примечание:** Раздел `cni.values` обычно не требует изменений, но если в кластере установлен Multus CNI, раскомментируйте и настройте, как показано выше.

**Проверьте успешность установки узла Istio CNI**

```bash
# Измените часть -nkube-system, если агент Istio CNI установлен в другом пространстве имен:
kubectl -nkube-system get po -lk8s-app=istio-cni-node
```

**Примечание:** Убедитесь, что все Pods-агенты CNI находятся в состоянии "Работает" перед переходом к следующему шагу.

### Настройка Istiod для внедрения CNI

По умолчанию Istiod использует веб-хук для внедрения контейнера `istio-init` для прозрачной перехвата трафика. Чтобы использовать Istio CNI вместо контейнера `istio-init`, необходимо дополнительно изменить ресурс ServiceMesh следующим образом:

```yaml
apiVersion: asm.alauda.io/v1alpha1
kind: ServiceMesh
spec:
  istioConfig:
    # Добавьте поле cni
    cni:
      enabled: true  # !Важно! Включите внедрение CNI. По умолчанию false
      # chained: true  # Используйте режим CNI с цепочкой, по умолчанию true. Забронировано для настройки (особенно для Multus CNI, который необходимо установить в false)
```

**Примечание:** Поле `.spec.istioConfig.cni.chained` должно быть установлено в false, если в кластере k8s установлен плагин Multus CNI.

После применения конфигурации оператор Istio изменит веб-хук Istiod, чтобы прекратить внедрение контейнера `istio-init`.

## Использование и проверка

После установки и настройки используйте обычный процесс внедрения услуг без каких-либо дополнительных изменений.

При использовании внедрения Istio CNI:

- Контейнер `istio-init` больше не будет присутствовать (прозрачный перехват трафика будет обрабатываться узлом-агентом Istio CNI).
- Вместо этого Istio внедрит контейнер с именем `istio-validation`, который проверяет, были ли успешно установлены правила iptables для прозрачного перехвата трафика.

## Расширенные параметры

```yaml
apiVersion: asm.alauda.io/v1alpha1
kind: ServiceMesh
spec:
  componentConfig:
    # (Установите плагин Istio CNI)
    - name: istioCni  # фиксировано как istioCni
      group: istio
      cni:
        values:
          repairPods: true
          deletePods: false
          labelPods: false
```

**Описание параметров:**

- `cni.values.repairPods`: (по умолчанию true) Пытается переопределить сеть, если сеть Pod настроена ненормально.
- `cni.values.deletePods`: (по умолчанию false) Автоматически удаляет Pod, если сеть настроена ненормально.
- `cni.values.labelPods`: (по умолчанию false) Только помечает Pod (по умолчанию метка `cni.istio.io/uninitialized=true`), если сеть настроена ненормально, позволяя пользователю справляться с этим.

Приоритет настройки: `repairPods` > `deletePods` > `labelPods`

## ЧаВо

Q: Как определить, установлен ли плагин Multus CNI?

A: Проверьте список плагинов в кластере, чтобы увидеть, установлен ли предоставленный платформой плагин Multus CNI. Если это так, пожалуйста, внимательно обратитесь к документации по установке и настройке, чтобы обеспечить нормальную работу в среде плагина Multus CNI.
