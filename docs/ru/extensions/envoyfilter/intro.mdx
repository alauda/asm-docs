---
weight: 10
sourceSHA: 3a0b9955e435a81f86ca14714066c807b29ccdc10f84b0d311e394a588b9cc92
---

# Введение

## Введение в EnvoyFilter

API EnvoyFilter является мощным механизмом настройки внутри сервисной сетки Istio, который предоставляет возможность тонкой настройки конфигурации прокси-сервера Envoy, генерируемой istiod. Этот функционал предназначен для опытных пользователей и позволяет вносить изменения в конкретные поля конфигурации Envoy, вставлять собственные фильтры и даже добавлять совершенно новые слушатели или кластеры. Хотя он предлагает беспрецедентную гибкость, EnvoyFilter требует тщательного применения, так как неправильные настройки могут повлиять на стабильность сетки.

Ресурсы EnvoyFilter применяются аддитивно через рабочие нагрузки. Несколько фильтров могут сосуществовать в одном пространстве имен, при этом порядок приложения следует этой иерархии: сначала все EnvoyFilters в [корневом пространстве имен конфигурации](https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#MeshConfig), затем те, что в конкретном пространстве имен рабочей нагрузки.

## Преимущества

Основные преимущества EnvoyFilter включают:

- **Гибкость настройки**\
  Позволяет напрямую манипулировать настройками прокси-сервера Envoy, выходя за пределы стандартных сетевых API Istio. Это позволяет реализовывать оптимизацию, специфичную для протокола, пользовательскую логику повторных попыток или экспериментальные функции, которые еще не поддерживаются нативно в Istio.

- **Тонкая настройка рабочих нагрузок**\
  Поддерживает целевую настройку с использованием селекторов рабочих нагрузок, позволяя операторам применять определенные конфигурации к конкретным сервисам или шлюзам без влияния на всю сетку.

- **Интеграция с Istio**\
  Бесшовно интегрируется с контрольной плоскостью Istio, сохраняя совместимость с существующими ресурсами Istio, такими как VirtualServices и DestinationRules.

- **Расширяемость протоколов**\
  Облегчает вставку пользовательских фильтров Envoy (L4/L7) для обработки проприетарных протоколов или реализации специализированной логики обработки трафика на уровне прокси.

## Сценарии применения

EnvoyFilter в основном используется в следующих сценариях:

- **Расширение протокола**\
  Реализация пользовательских парсеров протоколов или HTTP-фильтров для специализированных требований общения, которые не охвачены стандартной поддержкой Istio.

- **Манипуляция трафиком**\
  Вставка пользовательских фильтров WASM для изменения заголовков запросов/ответов, реализации сложной логики маршрутизации или выполнения трансляции протоколов на уровне прокси.

- **Усиление безопасности**\
  Добавление пользовательских фильтров авторизации или реализация логики валидации запросов, требующих более глубокую интеграцию с плоскостью данных Envoy.

- **Расширенные возможности наблюдения**\
  Настройка пользовательских форматов журналов доступа, инъекция заголовков трассировки или реализация фильтров для сбора метрик для специализированных требований мониторинга.

- **Настройка производительности**\
  Переопределение параметров конфигурации по умолчанию Envoy (например, настроек пула соединений, тайм-аутов) для конкретных сервисов, требующих оптимизированных характеристик производительности.

## Учетные соображения при использовании

При работе с EnvoyFilter учитывайте эти критические соображения:

- **Совместимость версий**\
  Конфигурации EnvoyFilter тесно связаны с конкретными версиями прокси-сервера Envoy. Любые изменения в контрольной плоскости Istio или версиях прокси могут потребовать обновления конфигураций. Всегда проверяйте конфигурации при обновлении версий.

- **Конфликты конфигурации**\
  Несколько EnvoyFilters, применяемых к одной рабочей нагрузке, обрабатываются последовательно по времени создания. Конфликтующие конфигурации могут привести к неопределенному поведению — убедитесь, что фильтры тщательно упорядочены и валидированы.

- **Связанность с реализацией**\
  Некоторые конфигурации могут зависеть от внутренних деталей реализации Istio. Рассмотрите альтернативные подходы с использованием стандартных API Istio, когда это возможно, для обеспечения долгосрочной совместимости.

- **Глобальное применение**\
  Для применения конфигураций по всей сетке создайте EnvoyFilters в корневом пространстве имен **без** селектора рабочей нагрузки. Используйте эту возможность с осторожностью, чтобы избежать непредвиденных побочных эффектов.

:::danger Предупреждение по операциям
EnvoyFilter работает на более низком уровне абстракции, чем стандартные ресурсы Istio. Всегда предпочтительнее использовать нативные API Istio (VirtualService, DestinationRule), когда это возможно, и резервировать EnvoyFilter для случаев, требующих настройки на уровне прокси, которую нельзя добиться с помощью абстракций более высокого уровня.
:::"
